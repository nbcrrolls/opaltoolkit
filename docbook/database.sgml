<chapter id="database" xreflabel="Opal State Database Installation Instruction">
<title>Opal State Database Installation Instruction</title>

<para>By default, Opal stores its state into an in-memory <ulink
type="http" url="http://hsqldb.org/">HSQL</ulink> database, so
it should work out of the box. However, for production systems you may wish
to store the Opal state in a real external database. This chapter describes
how to configure Opal to use PostgreSQL to store its state</para>

<orderedlist>
<listitem><para>Install a PostgreSQL database (version 8.2.x).</para></listitem>

<listitem><para>Create a database called <emphasis role="italics">opal_db</emphasis>, and a user called
<emphasis role="italics">opal_user</emphasis> with a password. Grant all permissions on opal_db to the
opal_user. Configure the database to accept remote JDBC connections (consult
the database documentation for this).</para>
</listitem>

<listitem><para>Edit the <emphasis
role="italics">etc/hibernate-opal.cfg.xml</emphasis> configuration file and
comment out the properties that are HSQL specific. In particular, the
following five lines should be commented out as follows:
<screen>
        &lt;!-- Database connection settings for HSQL --&gt;
&lt;!--         &lt;property name="connection.driver_class"&gt;org.hsqldb.jdbcDriver&lt;/property&gt; --&gt;
&lt;!--         &lt;property name="connection.url"&gt;jdbc:hsqldb:file:data/opaldb&lt;/property&gt; --&gt;
&lt;!--         &lt;property name="connection.username"&gt;sa&lt;/property&gt; --&gt;
&lt;!--         &lt;property name="connection.password"&gt;&lt;/property&gt; --&gt;
&lt;!--         &lt;property name="dialect"&gt;org.hibernate.dialect.HSQLDialect&lt;/property&gt; --&gt;
</screen> 
</para>
</listitem>

<listitem><para>Uncomment the properties that are PostgreSQL specific. In
particular, uncomment the following five lines as follows:
<screen>
        &lt;!-- Database connection settings for PostgreSQL --&gt;
        &lt;property name="connection.driver_class"&gt;org.postgresql.Driver&lt;/property&gt;
        &lt;property name="connection.url"&gt;jdbc:postgresql://localhost/opaldb&lt;/property&gt;
        &lt;property name="connection.username"&gt;opal_user&lt;/property&gt;
        &lt;property name="connection.password"&gt;opal_passwd&lt;/property&gt;
        &lt;property name="dialect"&gt;org.hibernate.dialect.PostgreSQLDialect&lt;/property&gt;
</screen>
</para>

<para>Note that you can change the property <emphasis
role="italics">connection.url</emphasis> to point to a database that is
running on another machine as long as it can accept JDBC connection from
the machine running the Opal services. If the database is running on the
same machine as the Opal server, there is no need to change the value of
this property.
</para>
</listitem>


<listitem><para>Reinstall Opal by running the following command:
<screen>
    ant install
</screen>
</para>
</listitem>

<listitem><para>Restart Tomcat for the changes to take effect.</para>
</listitem>
</orderedlist>

</chapter>
